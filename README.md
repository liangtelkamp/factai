# factai

Welcome to our github. For the course Fairness, Accountability, Confidentiality and Transparency in AI we have attempted to reproduce the paper ITI-GEN: Inclusive Text-to-Image Generation  by Zhang et al. (2023). 

There are several components to this project. Most of the code is given by Zhang et al. (2023), we made a few alterations to make it compatible with our server. 

- Due to licence issues, we cannot share the pre-trained checkpoints directly. Download it yourself and put the Stable Diffusion checkpoints at <path/to/sd-v1-4.ckpt>.
- HPS (Hard Prompt Searching): This folder contains the images generated with the Stable-Diffusion-v-1-4. This folder includes the evaluation jobfile for HPS. Generation of these images can be done through the following job:

```
srun python -u "/ITI-GEN/generate_baseline.py"\
    --prompt="a headshot of a person"\
    --plms \
    --config='/ITI-GEN/models/sd/configs/stable-diffusion/v1-inference.yaml' \
    --ckpt='/ITI-GEN/models/sd/models/ldm/stable-diffusion-v1/model.ckpt' \
    --seed=42 \
    --outdir="/Baseline_headshots/Baseline_400" \
    --n_iter=1 \
    --n_samples=1
```

- BASELINE: This folder contains 540 images generated by SD with the prompt 'a headshot of a person'. Furthermore we recreated the baseline of the paper by generating with SD 1000 images ('a headshot of a person', 'a headshot of a firefighter', 'a headshot of a worker', 'a headshot of a lawyer', 'a headshot of a professor'). This folder includes the evaluation jobfile for the baseline.

- results: This folder contains the output of the executed jobfiles. The results that are presented in tables/figures are included.

- embedding: 

- jobfiles: This folder contains all the jobfiles to execute the scripts. You do have to change the paths for yourself to make it compatible in your own environment.

1. Training is possible, here is an example (as a warning, you might have to download the used reference data sets)
```
# Run your code
srun python -u /ITI-GEN/train_iti_gen.py \
    --prompt='a headshot of a person' \
    --attr-list='Male' \
    --epochs=30 \
    --save-ckpt-per-epochs=10 \
    --data-path='/ITI-GEN/data' \
    --ckpt-path='/ITI-GEN/ckpts/test'
```


3. Generating images with ITI-GEN models
```
srun python -u /ITI-GEN/generation.py \
    --config='/ITI-GEN/models/sd/configs/stable-diffusion/v1-inference.yaml' \
    --ckpt='/ITI-GEN/models/sd/models/ldm/stable-diffusion-v1/model.ckpt' \
    --plms \
    --prompt-path='/ITI-GEN/ckpts/a_headshot_of_a_person_Male/original_prompt_embedding/basis_final_embed_29.pt'\
    --attr-list='Male' \
    --outdir='/ITI-GEN/ckpts/test/a_headshot_of_a_person_Male/original_prompt_embedding/sample_results' \
    --n_iter=10 \
    --n_rows=1 \
    --n_samples=1 \
    --prompt="a headshot of a person"
```

4. Evaluating images KL Divergence and FID score
```
# Do keep in mind to remove the grids from the sample_results folder to exclude the grids from evaluation
srun python -u /ITI-GEN/evaluation.py \
    --img-folder '/ITI-GEN/ckpts/a_headshot_of_a_person_Male/original_prompt_embedding/sample_results' \
    --class-list 'a headshot of a man' 'a headshot of a woman'
```

