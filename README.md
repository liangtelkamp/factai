# factai

Welcome to our github. For the course Fairness, Accountability, Confidentiality and Transparency in AI we have attempted to reproduce the paper ITI-GEN: Inclusive Text-to-Image Generation  by Zhang et al. (2023). 

This project comprises multiple components, with the majority of the code originating from Zhang et al. (2023). We have, however, made specific adjustments to ensure compatibility with our server environment.

- Due to licence issues, we cannot share the pre-trained checkpoints directly. Download it yourself and put the Stable Diffusion checkpoints at <path/to/sd-v1-4.ckpt>.
- For the exact code of the authors and execution we refer you to the their [repository](https://github.com/humansensinglab/ITI-GEN)
- Within this section, you will find a collection of images generated utilizing the Stable Diffusion model (v1.4). Additionally, we have included the evaluation jobfile for HPS. To generate these images, please follow the instructions below:
(warning: you might have to change the path to the ITI-GEN folder within the generation_baseline.py file)
```
srun python -u "/ITI-GEN/generate_baseline.py"\
    --prompt="a headshot of a person"\
    --plms \
    --config='/ITI-GEN/models/sd/configs/stable-diffusion/v1-inference.yaml' \
    --ckpt='/ITI-GEN/models/sd/models/ldm/stable-diffusion-v1/model.ckpt' \
    --seed=42 \
    --outdir="/Baseline_headshots/Baseline_400" \
    --n_iter=1 \
    --n_samples=1
```

- The BASELINE folder hosts 540 images generated by SD with the prompt 'a headshot of a person.' Additionally, we have attempted to recreate the paper's baseline by generating 1000 images, including 'a headshot of a firefighter,' 'a headshot of a worker,' 'a headshot of a lawyer,' and 'a headshot of a professor.' This section also includes the evaluation jobfile for the baseline.

- The 'results' folder contains the outputs of the executed jobfiles. It houses the tables and figures presenting our findings.

- embedding: 

- The 'jobfiles' directory contains a set of scripts ready for execution. However, it is necessary to customize the paths to align them with your specific environment. Here is a glimpse of what is available:

## 1. Training is possible, here is an example (as a warning, you might have to download the used reference data sets and alter the path to ITI-GEN in the train_iti_gen.py file)
```
# Run your code
srun python -u /ITI-GEN/train_iti_gen.py \
    --prompt='a headshot of a person' \
    --attr-list='Male' \
    --epochs=30 \
    --save-ckpt-per-epochs=10 \
    --data-path='/ITI-GEN/data' \
    --ckpt-path='/ITI-GEN/ckpts/test'
```


## 2. Generating images with ITI-GEN models (warning: you might have to change the path to the ITI-GEN folder within the generation.py file)
```
srun python -u /ITI-GEN/generation.py \
    --config='/ITI-GEN/models/sd/configs/stable-diffusion/v1-inference.yaml' \
    --ckpt='/ITI-GEN/models/sd/models/ldm/stable-diffusion-v1/model.ckpt' \
    --plms \
    --prompt-path='/ITI-GEN/ckpts/a_headshot_of_a_person_Male/original_prompt_embedding/basis_final_embed_29.pt'\
    --attr-list='Male' \
    --outdir='/ITI-GEN/ckpts/test/a_headshot_of_a_person_Male/original_prompt_embedding/sample_results' \
    --n_iter=10 \
    --n_rows=1 \
    --n_samples=1 \
    --prompt="a headshot of a person"
```

## 3. Evaluating images KL Divergence and FID score
```
# Do keep in mind to remove the grids from the sample_results folder to exclude the grids from evaluation
srun python -u /ITI-GEN/evaluation.py \
    --img-folder '/ITI-GEN/ckpts/a_headshot_of_a_person_Male/original_prompt_embedding/sample_results' \
    --class-list 'a headshot of a man' 'a headshot of a woman'
```
## 4. FairFace classifier
The FairFace classifier is used to classify the multi-category attributes 'age' and 'skin tone'.

The job file to run the code of the FairFace classifier is called classifier_fairface.job:
```
srun python -u classifier_FairFace/predict.py \
    --input_csv "classifier_FairFace/img_paths.csv" \
    --output_csv "classifier_FairFace/outputs.csv" \
    --image_path "ckpts/a_headshot_of_a_person_Male_Skin_tone/original_prompt_embedding/sample_results"
```
- '--input_csv': csv file of image paths where col name for image path is "img_path'.
- '--output_csv': csv file for the output of the classifier.
- '--image_path': directory where the images are stored.

The github page from the paper with the original code can be found here: https://github.com/dchen236/FairFace


